<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>EdTech Dashboard</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ea580c",
                        "primary-light": "#fb923c",
                        "primary-dark": "#c2410c",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1a2233",
                        "text-main-light": "#1f2938",
                        "text-main-dark": "#e5e7eb",
                        "text-muted-light": "#6b7280",
                        "text-muted-dark": "#9ca3af",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "2xl": "1rem", "full": "9999px"},
                },
            },
        }
    </script>
<style>
        /* Custom scrollbar for webkit */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
        }
        
        /* Chart Styles */
        .chart-grid {
            stroke: #e2e8f0;
            stroke-dasharray: 4, 4;
        }
        .dark .chart-grid {
            stroke: #374151;
        }
        .chart-line {
            fill: none;
            stroke: #ea580c;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .chart-area {
            fill: url(#gradientPrimary);
            opacity: 0.2;
        }
        
        /* Donut Chart */
        .donut-segment {
            fill: none;
            stroke-width: 20;
        }
        .donut-bg {
            stroke: #f3f4f6;
        }
        .dark .donut-bg {
            stroke: #374151;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-main-light dark:text-text-main-dark transition-colors duration-200 antialiased overflow-hidden h-screen flex">
<!-- Sidebar -->
<aside class="w-64 bg-surface-light dark:bg-surface-dark border-r border-gray-200 dark:border-gray-800 flex flex-col h-full flex-shrink-0 z-20 shadow-sm">
<div class="p-6 flex items-center gap-3">
<div class="w-8 h-8 rounded bg-primary flex items-center justify-center text-white font-bold text-lg">
                E
            </div>
<span class="text-xl font-bold tracking-tight text-gray-900 dark:text-white">EdTech Dashboard</span>
</div>
<nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
<a id="overview-nav" class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg bg-primary/10 text-primary dark:text-primary-light group transition-colors cursor-pointer">
<span class="material-icons text-[20px]">dashboard</span>
                Overview
            </a>
<a id="feedback-nav" class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-text-muted-light dark:text-text-muted-dark hover:bg-gray-50 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-white group transition-colors cursor-pointer">
<span class="material-icons text-[20px]">chat_bubble_outline</span>
                Feedback
                <span class="ml-auto bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 py-0.5 px-2 rounded-full text-xs font-semibold">12</span>
</a>

</nav>
<div class="p-4 border-t border-gray-200 dark:border-gray-800">
<a onclick="logout()" class="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-text-muted-light dark:text-text-muted-dark hover:bg-red-50 dark:hover:bg-red-900/20 hover:text-red-600 dark:hover:text-red-400 group transition-colors cursor-pointer">
<span class="material-icons text-[20px]">logout</span>
                Logout
            </a>
</div>
</aside>

<!-- Main Content -->
<main class="flex-1 overflow-y-auto relative h-full">
<!-- Overview Screen -->
<div id="overview-screen" class="screen">
<!-- Top Bar -->
<header class="bg-surface-light dark:bg-surface-dark/90 backdrop-blur-md sticky top-0 z-10 border-b border-gray-200 dark:border-gray-800 px-8 py-5 flex items-center justify-between">
<div>
<h1 class="text-2xl font-bold text-gray-900 dark:text-white">Dashboard Overview</h1>
<p class="text-sm text-text-muted-light dark:text-text-muted-dark mt-1">Monitoring metrics for active projects</p>
</div>
<div class="flex items-center gap-4">
<!-- Date Range Selector removed -->
</div>
</header>
<!-- Content Body -->
<div class="p-8 max-w-7xl mx-auto space-y-8">
<!-- KPI Cards Row -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<!-- KPI 1 -->
<div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm hover:shadow-md transition-shadow">
<div class="flex justify-between items-start">
<div>
<p class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark mb-1">Total Feedback</p>
<h3 class="text-3xl font-bold text-gray-900 dark:text-white" data-kpi="total-feedback">--</h3>
</div>
<div class="p-2 bg-primary/10 rounded-lg">
<span class="material-icons text-primary">reviews</span>
</div>
</div>
</div>
<!-- KPI 2 -->
<div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm hover:shadow-md transition-shadow">
<div class="flex justify-between items-start">
<div>
<p class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark mb-1">Active Sessions Today</p>
<h3 class="text-3xl font-bold text-gray-900 dark:text-white" data-kpi="active-sessions">--</h3>
</div>
<div class="p-2 bg-purple-500/10 rounded-lg">
<span class="material-icons text-purple-600 dark:text-purple-400">group</span>
</div>
</div>
</div>
</div>
<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<!-- Donut Chart -->
<div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm flex flex-col">
<div class="flex items-center justify-between mb-6">
<h3 class="text-lg font-bold text-gray-900 dark:text-white">Ratings Distribution</h3>
<button class="text-gray-400 hover:text-primary transition-colors">
<span class="material-icons text-sm">more_horiz</span>
</button>
</div>
<div class="flex-1 flex items-center justify-center relative">
<!-- SVG Donut Chart -->
<div class="relative w-48 h-48">
<svg class="w-full h-full transform -rotate-90" viewbox="0 0 100 100">
<!-- Background Circle -->
<circle class="donut-bg" cx="50" cy="50" fill="transparent" r="40"></circle>
<!-- Satisfied (65%) -->
<circle class="transition-all duration-1000 ease-out" cx="50" cy="50" fill="transparent" r="40" stroke="#ea580c" stroke-dasharray="251.2" stroke-dashoffset="87.92" stroke-width="12"></circle>
<!-- Neutral (25%) -->
<circle class="transition-all duration-1000 ease-out" cx="50" cy="50" fill="transparent" r="40" stroke="#93c5fd" stroke-dasharray="251.2" stroke-dashoffset="188.4" stroke-width="12" style="transform-origin: center; transform: rotate(234deg);"></circle>
<!-- Dissatisfied (10%) -->
<circle class="transition-all duration-1000 ease-out" cx="50" cy="50" fill="transparent" r="40" stroke="#e2e8f0" stroke-dasharray="251.2" stroke-dashoffset="226.08" stroke-width="12" style="transform-origin: center; transform: rotate(324deg);"></circle>
</svg>
<!-- Center Text -->
<div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
<span class="text-2xl font-bold text-gray-900 dark:text-white" data-avg="score">--</span>
<span class="text-xs text-gray-500 font-medium uppercase tracking-wider">Avg Score</span>
</div>
</div>
</div>
<div class="mt-6 space-y-3">
<div class="flex items-center justify-between text-sm">
<div class="flex items-center gap-2">
<span class="w-3 h-3 rounded-full bg-primary"></span>
<span class="text-gray-600 dark:text-gray-300">Satisfied</span>
</div>
<span class="font-semibold text-gray-900 dark:text-white" data-rating="satisfied">--%</span>
</div>
<div class="flex items-center justify-between text-sm">
<div class="flex items-center gap-2">
<span class="w-3 h-3 rounded-full bg-blue-300"></span>
<span class="text-gray-600 dark:text-gray-300">Neutral</span>
</div>
<span class="font-semibold text-gray-900 dark:text-white" data-rating="neutral">--%</span>
</div>
<div class="flex items-center justify-between text-sm">
<div class="flex items-center gap-2">
<span class="w-3 h-3 rounded-full bg-gray-200 dark:bg-gray-700"></span>
<span class="text-gray-600 dark:text-gray-300">Dissatisfied</span>
</div>
<span class="font-semibold text-gray-900 dark:text-white" data-rating="dissatisfied">--%</span>
</div>
</div>
</div>
<!-- Source Distribution Chart -->
<div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm lg:col-span-2 flex flex-col">
<div class="flex items-center justify-between mb-6">
<div>
<h3 class="text-lg font-bold text-gray-900 dark:text-white">Feedback by Source</h3>
<p class="text-xs text-text-muted-light dark:text-text-muted-dark">Distribution between Chatbot and Document feedback</p>
</div>
</div>
<div class="flex-1 flex items-center justify-center gap-12">
<!-- Chatbot -->
<div class="text-center">
<div class="w-32 h-32 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center mb-3">
<div class="text-center">
<span id="chatbot-count" class="text-3xl font-bold text-purple-600 dark:text-purple-400">--</span>
<p class="text-xs text-purple-600 dark:text-purple-400 font-medium">responses</p>
</div>
</div>
<p class="text-sm font-semibold text-gray-700 dark:text-gray-300">Chatbot</p>
<p id="chatbot-percent" class="text-xs text-gray-500">--%</p>
</div>
<!-- Document -->
<div class="text-center">
<div class="w-32 h-32 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center mb-3">
<div class="text-center">
<span id="document-count" class="text-3xl font-bold text-orange-600 dark:text-orange-400">--</span>
<p class="text-xs text-orange-600 dark:text-orange-400 font-medium">responses</p>
</div>
</div>
<p class="text-sm font-semibold text-gray-700 dark:text-gray-300">Document</p>
<p id="document-percent" class="text-xs text-gray-500">--%</p>
</div>
</div>
</div>
</div>
<!-- Recent Activity Table -->
<div class="bg-surface-light dark:bg-surface-dark rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm overflow-hidden">
<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center">
<h3 class="text-lg font-bold text-gray-900 dark:text-white">Recent Feedback</h3>
<a class="text-sm text-primary font-medium hover:underline cursor-pointer" id="view-all-feedback">View All</a>
</div>
<div class="overflow-x-auto">
<table class="w-full text-left border-collapse">
<thead>
<tr class="bg-gray-50 dark:bg-gray-800/50 text-xs uppercase text-gray-500 font-semibold tracking-wider">
<th class="px-6 py-3">User</th>
<th class="px-6 py-3">Rating</th>
<th class="px-6 py-3">Comment</th>
<th class="px-6 py-3">Date</th>
<th class="px-6 py-3 text-right">Status</th>
</tr>
</thead>
<tbody id="recent-feedback-tbody" class="divide-y divide-gray-200 dark:divide-gray-800">
<!-- Data will be loaded dynamically -->
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<!-- Feedback Screen -->
<div id="feedback-screen" class="screen hidden">
<!-- Top Header -->
<header class="bg-surface-light dark:bg-surface-dark border-b border-gray-200 dark:border-gray-800 px-8 py-5 flex items-center justify-between">
<div>
<h1 class="text-2xl font-bold text-gray-900 dark:text-white">Feedback Records</h1>
<p class="text-sm text-text-muted-light dark:text-text-muted-dark mt-1">Detailed feedback submissions and analytics</p>
</div>
<div class="flex items-center gap-3">
<button id="export-csv-btn" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
<span class="material-icons text-base">file_download</span>
                    Export CSV
                </button>
</div>
</header>

<!-- Scrollable Content Area -->
<div class="p-8 max-w-7xl mx-auto space-y-6">
<!-- Filters Card -->
<section class="bg-surface-light dark:bg-surface-dark rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm p-5">
<div class="flex flex-col md:flex-row md:items-end gap-4">
<!-- Search -->
<div class="flex-1 min-w-[200px]">
<label class="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wider">Search</label>
<div class="relative">
<span class="material-icons absolute left-3 top-2.5 text-gray-400 text-lg">search</span>
<input id="search-input" class="w-full pl-10 pr-4 py-2 text-sm bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-gray-900 dark:text-white" placeholder="Search feedback content..." type="text"/>
</div>
</div>
<!-- Rating Filter -->
<div class="w-full md:w-56">
<label class="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wider">Sentiment</label>
<div class="relative">
<span class="material-icons absolute left-3 top-2.5 text-gray-400 text-lg">stars</span>
<select id="rating-filter" class="w-full pl-10 pr-8 py-2 text-sm bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary appearance-none cursor-pointer text-gray-900 dark:text-white">
<option value="">All Ratings</option>
<option value="satisfied">Satisfied</option>
<option value="neutral">Neutral</option>
<option value="dissatisfied">Dissatisfied</option>
</select>
<span class="material-icons absolute right-2 top-2.5 text-gray-400 text-lg pointer-events-none">expand_more</span>
</div>
</div>
<!-- Action Buttons -->
<div class="flex gap-2 mt-2 md:mt-0">
<button id="filter-btn" class="px-4 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary-dark shadow-sm shadow-primary/30 transition-all flex items-center gap-2">
<span class="material-icons text-sm">filter_list</span>
                                Filter
                            </button>
<button id="reset-btn" class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 text-sm font-medium rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                                Reset
                            </button>
</div>
</div>
</section>
<!-- Data Table Card -->
<section class="bg-surface-light dark:bg-surface-dark rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm overflow-hidden flex flex-col">
<!-- Table Header Actions -->
<div class="px-6 py-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
<div class="flex items-center gap-2">
<h2 class="text-sm font-semibold text-gray-800 dark:text-gray-200">All Feedback</h2>
<span id="total-feedback-count" class="px-2 py-0.5 rounded-full bg-gray-100 dark:bg-gray-800 text-xs font-medium text-gray-500">--</span>
</div>
</div>
<!-- Responsive Table Container -->
<div class="overflow-x-auto">
<table class="w-full text-left border-collapse">
<thead>
<tr class="bg-gray-50 dark:bg-gray-800/50 border-b border-gray-200 dark:border-gray-800">
<th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider w-32">Session ID</th>
<th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider w-32">Source</th>
<th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider w-40">Rating</th>
<th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Feedback</th>
</tr>
</thead>
<tbody id="feedback-table-tbody" class="divide-y divide-gray-100 dark:divide-gray-800">
<!-- Data will be loaded dynamically -->
</tbody>
</table>
</div>
<!-- Pagination -->
<div class="px-6 py-4 border-t border-gray-200 dark:border-gray-800 flex items-center justify-between bg-gray-50 dark:bg-gray-900/50">
<div id="pagination-info" class="text-sm text-gray-500">
                            Showing <span class="font-medium text-gray-700 dark:text-gray-300">0</span> to <span class="font-medium text-gray-700 dark:text-gray-300">0</span> of <span class="font-medium text-gray-700 dark:text-gray-300">0</span> results
                        </div>
<div class="flex items-center gap-2">
<button id="prev-btn" class="px-3 py-1.5 text-sm font-medium text-gray-500 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Previous
                            </button>
<button id="next-btn" class="px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                Next
                            </button>
</div>
</div>
</section>
</div>
</div>
</main>
<script src="api-service.js"></script>
<script>
// Auth check - redirect to login if not authenticated
(function() {
    const token = localStorage.getItem('dashboard_token');
    if (!token) {
        // Only redirect if user didn't just come from login (to prevent loops)
        if (!document.referrer.includes('login.html')) {
            window.location.href = 'login.html';
        }
        return;
    }
    
    // Verify token on load (but don't redirect immediately on failure)
    fetch('https://edudoc-610o.onrender.com/api/auth/verify', {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(res => {
        if (!res.ok) {
            localStorage.removeItem('dashboard_token');
            localStorage.removeItem('dashboard_admin');
            // Delay redirect to prevent immediate loops
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1000);
        }
    })
    .catch(() => {
        // If verification fails, still allow access (might be offline)
        console.warn('Token verification failed, continuing anyway');
    });
})();

// Logout function
function logout() {
    localStorage.removeItem('dashboard_token');
    localStorage.removeItem('dashboard_admin');
    window.location.href = 'login.html';
}

// Navigation functionality
document.addEventListener('DOMContentLoaded', function() {
    const overviewNav = document.getElementById('overview-nav');
    const feedbackNav = document.getElementById('feedback-nav');
    const viewAllFeedback = document.getElementById('view-all-feedback');
    
    const overviewScreen = document.getElementById('overview-screen');
    const feedbackScreen = document.getElementById('feedback-screen');
    
    // Pagination state
    let currentPage = 1;
    let totalPages = 1;
    let currentFilters = { search: '', rating: '' };
    let allFeedbackData = [];
    
    // Function to show overview screen
    function showOverview() {
        overviewScreen.classList.remove('hidden');
        feedbackScreen.classList.add('hidden');
        
        // Update nav styles
        overviewNav.className = 'nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg bg-primary/10 text-primary dark:text-primary-light group transition-colors cursor-pointer';
        feedbackNav.className = 'nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-text-muted-light dark:text-text-muted-dark hover:bg-gray-50 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-white group transition-colors cursor-pointer';
        
        // Load overview data
        loadDashboardData();
    }
    
    // Function to show feedback screen
    function showFeedback() {
        overviewScreen.classList.add('hidden');
        feedbackScreen.classList.remove('hidden');
        
        // Update nav styles
        feedbackNav.className = 'nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg bg-primary/10 text-primary dark:text-primary-light group transition-colors cursor-pointer';
        overviewNav.className = 'nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-text-muted-light dark:text-text-muted-dark hover:bg-gray-50 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-white group transition-colors cursor-pointer';
        
        // Load feedback data
        currentPage = 1;
        loadFeedbackData();
    }
    
    // Event listeners
    overviewNav.addEventListener('click', showOverview);
    feedbackNav.addEventListener('click', showFeedback);
    viewAllFeedback.addEventListener('click', showFeedback);
    
    // Filter and pagination event listeners
    document.getElementById('filter-btn')?.addEventListener('click', () => {
        currentFilters.search = document.getElementById('search-input')?.value || '';
        currentFilters.rating = document.getElementById('rating-filter')?.value || '';
        currentPage = 1;
        loadFeedbackData();
    });
    
    document.getElementById('reset-btn')?.addEventListener('click', () => {
        document.getElementById('search-input').value = '';
        document.getElementById('rating-filter').value = '';
        currentFilters = { search: '', rating: '' };
        currentPage = 1;
        loadFeedbackData();
    });
    
    document.getElementById('prev-btn')?.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            loadFeedbackData();
        }
    });
    
    document.getElementById('next-btn')?.addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentPage++;
            loadFeedbackData();
        }
    });
    
    // Export CSV functionality
    document.getElementById('export-csv-btn')?.addEventListener('click', exportToCSV);
    
    // Load initial data
    loadDashboardData();
    
    // Dashboard Data Loading Functions
    async function loadDashboardData() {
        try {
            // Load KPI stats
            const stats = await window.feedbackAPI.getDashboardStats();
            updateKPICards(stats);
            
            // Load ratings distribution
            const ratings = await window.feedbackAPI.getRatingsDistribution();
            updateDonutChart(ratings);
            
            // Load source distribution
            const sources = await window.feedbackAPI.getSourceDistribution();
            updateSourceChart(sources);
            
            // Load recent feedback
            const recent = await window.feedbackAPI.getRecentFeedback(5);
            updateRecentFeedbackTable(recent);
            
            // Update sidebar feedback count
            updateFeedbackCount(stats.totalFeedback);
            
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            showErrorMessage('Failed to load dashboard data');
        }
    }
    
    async function loadFeedbackData() {
        try {
            const params = { 
                page: currentPage, 
                limit: 10,
                search: currentFilters.search,
                rating: currentFilters.rating
            };
            const feedback = await window.feedbackAPI.getAllFeedback(params);
            allFeedbackData = feedback.feedback;
            totalPages = feedback.pagination.totalPages;
            updateFeedbackTable(feedback);
            updatePaginationButtons(feedback.pagination);
        } catch (error) {
            console.error('Error loading feedback data:', error);
            showErrorMessage('Failed to load feedback data');
        }
    }
    
    function updateFeedbackCount(count) {
        const countEl = feedbackNav.querySelector('span.ml-auto');
        if (countEl) {
            countEl.textContent = count;
        }
    }
    
    // Update Functions
    function updateKPICards(stats) {
        const totalFeedbackEl = document.querySelector('[data-kpi="total-feedback"]');
        if (totalFeedbackEl) {
            totalFeedbackEl.textContent = stats.totalFeedback.toLocaleString();
        }
        
        const activeSessionsEl = document.querySelector('[data-kpi="active-sessions"]');
        if (activeSessionsEl) {
            activeSessionsEl.textContent = stats.activeSessions;
        }
    }
    
    function updateDonutChart(ratings) {
        const satisfiedEl = document.querySelector('[data-rating="satisfied"]');
        if (satisfiedEl) satisfiedEl.textContent = `${ratings.satisfied}%`;
        
        const neutralEl = document.querySelector('[data-rating="neutral"]');
        if (neutralEl) neutralEl.textContent = `${ratings.neutral}%`;
        
        const dissatisfiedEl = document.querySelector('[data-rating="dissatisfied"]');
        if (dissatisfiedEl) dissatisfiedEl.textContent = `${ratings.dissatisfied}%`;
        
        const avgScoreEl = document.querySelector('[data-avg="score"]');
        if (avgScoreEl) avgScoreEl.textContent = ratings.averageScore;
    }
    
    function updateSourceChart(sources) {
        document.getElementById('chatbot-count').textContent = sources.chatbot.count;
        document.getElementById('chatbot-percent').textContent = `${sources.chatbot.percent}%`;
        document.getElementById('document-count').textContent = sources.document.count;
        document.getElementById('document-percent').textContent = `${sources.document.percent}%`;
    }
    
    function updateRecentFeedbackTable(recent) {
        const tbody = document.querySelector('#recent-feedback-tbody');
        if (!tbody) return;
        
        if (recent.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No feedback yet</td></tr>';
            return;
        }
        
        tbody.innerHTML = recent.map(item => `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center gap-3">
                        <div class="h-8 w-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center font-bold text-xs">
                            ${item.user.slice(-2).toUpperCase()}
                        </div>
                        <span class="text-sm font-medium text-gray-900 dark:text-white">${item.user}</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex text-yellow-400 text-sm">
                        ${generateStarRating(item.rating)}
                    </div>
                </td>
                <td class="px-6 py-4">
                    <p class="text-sm text-gray-600 dark:text-gray-400 max-w-xs">${item.comment}</p>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.date}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                    <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300">${item.status}</span>
                </td>
            </tr>
        `).join('');
    }
    
    function updateFeedbackTable(feedbackData) {
        const tbody = document.querySelector('#feedback-table-tbody');
        const totalCountEl = document.getElementById('total-feedback-count');
        if (!tbody) return;
        
        if (totalCountEl) {
            totalCountEl.textContent = feedbackData.pagination.totalItems;
        }
        
        if (feedbackData.feedback.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">No feedback found</td></tr>';
            return;
        }
        
        tbody.innerHTML = feedbackData.feedback.map(item => `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors group">
                <td class="px-6 py-4">
                    <span class="text-sm font-medium text-primary">
                        #${item.sessionId.slice(-6).toUpperCase()}
                    </span>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${item.source === 'chatbot' ? 'bg-purple-100 text-purple-700' : 'bg-orange-100 text-orange-700'}">
                        ${item.source === 'chatbot' ? 'Chatbot' : 'Document'}
                    </span>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium 
                        ${item.rating.label === 'Satisfied' ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400' : 
                          item.rating.label === 'Neutral' ? 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400' : 
                          'bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-400'}">
                        <span class="material-icons text-[14px]">${item.rating.icon}</span>
                        ${item.rating.label}
                    </span>
                </td>
                <td class="px-6 py-4">
                    <p class="text-sm text-gray-600 dark:text-gray-300">
                        ${item.feedback}
                    </p>
                </td>
            </tr>
        `).join('');
    }
    
    function updatePaginationButtons(pagination) {
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const paginationInfo = document.getElementById('pagination-info');
        
        if (prevBtn) {
            prevBtn.disabled = pagination.currentPage <= 1;
        }
        if (nextBtn) {
            nextBtn.disabled = pagination.currentPage >= pagination.totalPages;
        }
        
        if (paginationInfo) {
            const start = pagination.totalItems === 0 ? 0 : (pagination.currentPage - 1) * pagination.itemsPerPage + 1;
            const end = Math.min(pagination.currentPage * pagination.itemsPerPage, pagination.totalItems);
            
            paginationInfo.innerHTML = `
                Showing <span class="font-medium text-gray-700 dark:text-gray-300">${start}</span> to 
                <span class="font-medium text-gray-700 dark:text-gray-300">${end}</span> of 
                <span class="font-medium text-gray-700 dark:text-gray-300">${pagination.totalItems}</span> results
            `;
        }
    }
    
    // Export to CSV
    function exportToCSV() {
        if (allFeedbackData.length === 0) {
            alert('No data to export');
            return;
        }
        
        const headers = ['Session ID', 'Source', 'Rating', 'Feedback', 'Created At'];
        const rows = allFeedbackData.map(item => [
            item.sessionId,
            item.source || 'document',
            item.rating.label,
            `"${item.feedback.replace(/"/g, '""')}"`,
            new Date(item.createdAt).toLocaleString()
        ]);
        
        const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `feedback_export_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    }
    
    // Helper Functions
    function generateStarRating(rating) {
        const stars = [];
        const maxStars = 5;
        let filledStars = 3;
        
        if (rating && rating.label) {
            switch (rating.label) {
                case 'Satisfied': filledStars = 5; break;
                case 'Neutral': filledStars = 3; break;
                case 'Dissatisfied': filledStars = 1; break;
            }
        }
        
        for (let i = 1; i <= maxStars; i++) {
            if (i <= filledStars) {
                stars.push('<span class="material-icons text-[16px]">star</span>');
            } else {
                stars.push('<span class="material-icons text-gray-300 dark:text-gray-600 text-[16px]">star</span>');
            }
        }
        
        return stars.join('');
    }
    
    function showErrorMessage(message) {
        console.error(message);
    }
});
</script>

</body>
</html>

